(()=>{"use strict";class t{constructor(t){this.vendorProductIDs=t,this.serial=void 0,navigator.serial.addEventListener("connect",(t=>{console.log("Detected serial device"),this.connect()})),navigator.serial.addEventListener("disconnect",(t=>{this.disconnect()})),this.encoder=new TextEncoder,this.manuallyConnecting=!1,this.connected=!1,this.onConnect=()=>{},this.onDisconnect=()=>{},this.onData=t=>{}}async write(t,e=!0){this.writer&&(e?await this.writer.write(this.encoder.encode(t)):await this.writer.write(t))}async#t(){for(;this.connected&&this.port.readable;){this.port.readable.locked||(this.reader=this.port.readable.getReader());try{for(;;){const{value:t,done:e}=await this.reader.read();if(e){this.reader.releaseLock();break}t&&this.onData(t)}}catch(t){}}}async disconnect(){this.connected&&(this.reader.releaseLock(),this.writer.releaseLock(),this.port.close(),this.reader=void 0,this.writer=void 0,this.port=void 0,this.connected=!1,this.onDisconnect(),console.log("Serial disconnected!"))}async#e(t){console.log("Opening port...");try{await t.open({baudRate:2e6,bufferSize:2048}),this.port=t,this.connected=!0,this.reader=void 0,this.writer=await this.port.writable.getWriter(),this.#t(),await this.onConnect(),console.log("Serial connected!")}catch(t){"InvalidStateError"==t.name?(console.error("Port already open..."),console.log("Port already open...")):"NetworkError"==t.name?(console.error("Failed to open port, is something using it?"),console.log("Failed to open port, is something using it?")):console.error(t)}}async attemptAutoConnect(){if(0==this.manuallyConnecting){console.log("Attempting auto connect...");let t=await navigator.serial.getPorts();for(let e=0;e<t.length;e++)for(let i=0;i<this.vendorProductIDs.length;i++){let s=t[e].getInfo();if(s.usbVendorId==this.vendorProductIDs[i].usbVendorId&&s.usbProductId==this.vendorProductIDs[i].usbProductId)return await this.#e(t[e]),!0}}return!1}async connect(){if(0==await this.attemptAutoConnect()){this.manuallyConnecting=!0;try{console.log("Waiting on device selection...");let t=await navigator.serial.requestPort({filters:this.vendorProductIDs});await this.#e(t)}catch(t){console.log("No device selected for connection...")}this.manuallyConnecting=!1}}}async function e(t,e=!0){return new Promise(((i,s)=>{let n=document.getElementById(t);e?(n.classList.remove("invisible","absolute","opacity-0"),n.classList.add("opacity-100"),i()):(n.classList.remove("opacity-100"),n.classList.add("invisible","opacity-0"),setTimeout((()=>{n.classList.add("absolute"),i()}),300))}))}let i=document.getElementById("canvasOutput"),s=i.getContext("2d"),n=document.getElementById("btnConnectTV"),r=(document.getElementById("cropSelect"),document.getElementById("inputContain")),a=document.getElementById("inputCover"),o=document.getElementById("inputFill");"serial"in navigator||(n.disabled=!0,e("errorAlert",!0),stop());let h=new class{constructor(){this.TINYTV_2_W=216,this.TINYTV_2_H=135,this.TINYTV_MINI_W=64,this.TINYTV_MINI_H=64,this.TINYTV_ROUND_W=240,this.TINYTV_ROUND_H=240,this.TV_TYPES={NONE:"NONE",TINYTV_2:"TV2",TINYTV_MINI:"TVMINI",TINYTV_ROUND:"TVROUND"},this.TV_JPEG_QUALITIES={TINYTV_2:.8,TINYTV_MINI:.92,TINYTV_ROUND:.6},this.TV_FIT_TYPES={CONTAIN:"CONTAIN",COVER:"COVER",FILL:"FILL"},this.textDecoder=new TextDecoder,this.detectedTVType=this.TV_TYPES.NONE,this.currentFitType=void 0,this.lastFrameSent=!0,this.serial=new t([{usbVendorId:11914,usbProductId:5},{usbVendorId:11914,usbProductId:10}]),this.serial.onConnect=()=>{this.#i()},this.serial.onDisconnect=()=>{this.#s()},this.serial.onData=t=>{this.#n(t)},this.receivedText="",this.streamCapture=void 0,this.streamVideoTrack=void 0,this.streamProcessor=void 0,this.streamGenerator=void 0,this.streamTransformer=void 0,this.fitFrameX=0,this.fitFrameY=0,this.fitFrameW=this.TINYTV_2_W,this.fitFrameH=this.TINYTV_2_H,this.currentJPEGQuality=void 0,this.offscreenCanvas=new OffscreenCanvas(this.fitFrameW,this.fitFrameH),this.offscreenCanvasCtx=this.offscreenCanvas.getContext("2d"),this.onSerialConnect=()=>{},this.onSerialDisconnect=()=>{},this.onTVDetected=t=>{},this.onStreamReady=()=>{},this.onNewCompressedBitmap=(t,e,i)=>{}}#r(){let t,e=()=>{this.detectedTVType==this.TV_TYPES.NONE&&this.serial.connected&&(t=setTimeout((()=>{this.serial.write("TYPE",!0),e()}),100))};e()}#i(){this.receivedText="",this.onSerialConnect(),setTimeout((()=>{this.#r()}),250)}#s(){this.detectedTVType=this.TV_TYPES.NONE,this.onSerialDisconnect(),this.#a()}async#o(t,e){if(this.lastFrameSent){this.lastFrameSent=!1;let e=this.offscreenCanvas.width,i=this.offscreenCanvas.height;this.#h(void 0,t.codedWidth,t.codedHeight),this.offscreenCanvasCtx.beginPath(),this.offscreenCanvasCtx.rect(0,0,e,i),this.offscreenCanvasCtx.fillStyle="black",this.offscreenCanvasCtx.fill(),this.offscreenCanvasCtx.drawImage(t,this.fitFrameX,this.fitFrameY,this.fitFrameW,this.fitFrameH),this.offscreenCanvas.convertToBlob({type:"image/jpeg",quality:this.currentJPEGQuality}).then((t=>{this.serial.connected?t.arrayBuffer().then((async e=>{await this.serial.write(new Uint8Array([t.size>>8&255,255&t.size]),!1),await this.serial.write(new Uint8Array(e),!1),this.lastFrameSent=!0})):this.lastFrameSent=!0,createImageBitmap(t,0,0,e,i).then((t=>{this.onNewCompressedBitmap(t,e,i)}))}))}t.close()}async#c(){return new Promise(((t,e)=>{navigator.mediaDevices.getDisplayMedia(this.DISPLAY_MEDIA_OPTIONS).then((e=>{this.streamCapture=e,this.streamVideoTrack=this.streamCapture.getVideoTracks()[0],this.streamProcessor=new MediaStreamTrackProcessor({track:this.streamVideoTrack}),this.streamGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.streamTransformer=new TransformStream({transform:this.#o.bind(this),writableStrategy:{highWaterMark:1},readableStrategy:{highWaterMark:1}}),this.streamProcessor.readable.pipeThrough(this.streamTransformer).pipeTo(this.streamGenerator.writable),t()})).catch((t=>{e(t)}))}))}#a(){null!=this.streamVideoTrack&&this.streamVideoTrack.stop(),this.lastFrameSent=!0}#T(t){this.onTVDetected(t),this.#c().then((t=>{this.onStreamReady()})).catch((t=>{this.disconnectSerial()}))}#d(t,e,i,s){this.fitFrameW=t,this.fitFrameH=s*(t/i),this.fitFrameX=0,this.fitFrameY=e/2-this.fitFrameH/2}#l(t,e,i,s){this.fitFrameW=i*(e/s),this.fitFrameH=e,this.fitFrameX=t/2-this.fitFrameW/2,this.fitFrameY=0}#I(t,e,i,s){i>s?this.#d(t,e,i,s):this.#l(t,e,i,s)}#_(t,e,i,s){i<s?this.#d(t,e,i,s):this.#l(t,e,i,s)}#V(t,e){this.fitFrameW=t,this.fitFrameH=e,this.fitFrameX=0,this.fitFrameY=0}#h(t,e,i){null==t&&null==this.currentFitType?(t=this.TV_FIT_TYPES.CONTAIN,this.currentFitType=t):null!=t&&null!=this.currentFitType?this.currentFitType=t:null==t&&null!=this.currentFitType&&(t=this.currentFitType),this.detectedTVType==this.TV_TYPES.TINYTV_2?null==t||t==this.TV_FIT_TYPES.CONTAIN?this.#I(this.TINYTV_2_W,this.TINYTV_2_H,e,i):t==this.TV_FIT_TYPES.COVER?this.#_(this.TINYTV_2_W,this.TINYTV_2_H,e,i):t==this.TV_FIT_TYPES.FILL&&this.#V(this.TINYTV_2_W,this.TINYTV_2_H):this.detectedTVType==this.TV_TYPES.TINYTV_MINI?null==t||t==this.TV_FIT_TYPES.CONTAIN?this.#I(this.TINYTV_MINI_W,this.TINYTV_MINI_H,e,i):t==this.TV_FIT_TYPES.COVER?this.#_(this.TINYTV_MINI_W,this.TINYTV_MINI_H,e,i):t==this.TV_FIT_TYPES.FILL&&this.#V(this.TINYTV_MINI_W,this.TINYTV_MINI_H):this.detectedTVType==this.TV_TYPES.TINYTV_ROUND&&(null==t||t==this.TV_FIT_TYPES.CONTAIN?this.#I(this.TINYTV_ROUND_W,this.TINYTV_ROUND_H,e,i):t==this.TV_FIT_TYPES.COVER?this.#_(this.TINYTV_ROUND_W,this.TINYTV_ROUND_H,e,i):t==this.TV_FIT_TYPES.FILL&&this.#V(this.TINYTV_ROUND_W,this.TINYTV_ROUND_H))}setScreenFit(t){t!=this.TV_FIT_TYPES.CONTAIN&&t!=this.TV_FIT_TYPES.COVER&&t!=this.TV_FIT_TYPES.FILL||(this.currentFitType=t)}#n(t){let e=this.textDecoder.decode(t);this.detectedTVType==this.TV_TYPES.NONE&&(this.receivedText+=e,-1!=this.receivedText.indexOf(this.TV_TYPES.TINYTV_2)?(this.detectedTVType=this.TV_TYPES.TINYTV_2,this.offscreenCanvas.width=this.TINYTV_2_W,this.offscreenCanvas.height=this.TINYTV_2_H,this.currentJPEGQuality=this.TV_JPEG_QUALITIES.TINYTV_2,this.#T("TinyTV 2")):-1!=this.receivedText.indexOf(this.TV_TYPES.TINYTV_MINI)?(this.detectedTVType=this.TV_TYPES.TINYTV_MINI,this.offscreenCanvas.width=this.TINYTV_MINI_W,this.offscreenCanvas.height=this.TINYTV_MINI_H,this.currentJPEGQuality=this.TV_JPEG_QUALITIES.TINYTV_MINI,this.#T("TinyTV Mini")):-1!=this.receivedText.indexOf(this.TV_TYPES.TINYTV_ROUND)&&(this.detectedTVType=this.TV_TYPES.TINYTV_ROUND,this.offscreenCanvas.width=this.TINYTV_ROUND_W,this.offscreenCanvas.height=this.TINYTV_ROUND_H,this.currentJPEGQuality=this.TV_JPEG_QUALITIES.TINYTV_ROUND,this.#T("TinyTV Round")))}connectSerial(){this.serial.connect()}disconnectSerial(){this.serial.disconnect()}};h.onSerialConnect=()=>{n.classList.add("btn-warning"),n.innerText="Stop",n.onclick=()=>{h.disconnectSerial()},e("divDetectingTVType",!0)},h.onSerialDisconnect=()=>{n.classList.remove("btn-warning"),n.innerText="Connect TV",n.onclick=()=>{h.connectSerial()},e("divDetectingTVType",!1),e("divStreamingInterface",!1)},h.onTVDetected=t=>{e("divDetectingTVType",!1).then((async e=>{!async function(t,e){new Promise(((i,s)=>{let n=document.getElementById(t);document.getElementById(t+"Text").innerText=e,n.classList.remove("invisible","opacity-0"),n.classList.add("opacity-100"),setTimeout((()=>{n.classList.remove("opacity-100"),n.classList.add("invisible","opacity-0"),setTimeout((()=>{i()}),300)}),2250)}))}("detectedAlert","Detected "+t+"!")}))},h.onStreamReady=()=>{e("divStreamingInterface",!0)},h.onNewCompressedBitmap=(t,e,n)=>{i.width=e,i.height=n,s.drawImage(t,0,0,e,n)},n.onclick=()=>{h.connectSerial()},r.oninput=t=>{h.setScreenFit(h.TV_FIT_TYPES.CONTAIN)},a.oninput=t=>{h.setScreenFit(h.TV_FIT_TYPES.COVER)},o.oninput=t=>{h.setScreenFit(h.TV_FIT_TYPES.FILL)}})();